<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Redis的多机机制（主从、哨兵、集群）&nbsp;|&nbsp;Junying Shao&#39;s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Redis的多机机制（主从、哨兵、集群）">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;⛸️&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;⛸️&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Redis的多机机制（主从、哨兵、集群）</h1>
    
      <div class="DateTagBar">
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/redis.html">redis</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/分布式.html">分布式</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/dac3e16062aa4b19bf1469d3c22c83ea" class="PageRoot"><h1 id="https://www.notion.so/11d576082711452fa26bfd8f958d7799" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/11d576082711452fa26bfd8f958d7799"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">主从复制</span></span></h1><h2 id="https://www.notion.so/cb89814c742a47b0b10bd314a62475e2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cb89814c742a47b0b10bd314a62475e2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">增量复制</span></span></h2><div id="https://www.notion.so/c429a7a2212c4a639e6635c7a6b86a8b" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F20c7d768-b010-4d38-b8bd-20cc5afa8f73%2FUntitled.png?width=144&amp;table=block&amp;id=c429a7a2-212c-4a63-9e66-35c7a6b86a8b"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F20c7d768-b010-4d38-b8bd-20cc5afa8f73%2FUntitled.png?width=144&amp;table=block&amp;id=c429a7a2-212c-4a63-9e66-35c7a6b86a8b" style="width:144px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/7be5fcfba2864e5ba135d9a2827568d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">主节点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/951cc4f8ad374a4681fe4cbf9a801d35" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">主节点将那些会更改自己状态的指令记录在本地的内存buffer中。</span></span></li><li id="https://www.notion.so/ade9234cd2194717b9c3460dd037c7dc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">异步将指令同步到从节点</span></span></li></ul><div id="https://www.notion.so/28e0177be8c643ca8ba5935092cf7c55" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">从节点</strong></span><span class="SemanticString">：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/332f764d928d404abe2836e4161da85d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">执行同步的指令流</span></span></li><li id="https://www.notion.so/804e7eb9e04946ecab061dc1773530b1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">想主节点反馈自己同步到哪里了。</span></span></li></ul><h2 id="https://www.notion.so/9ee0e2508e7540f792c7a0dcdd853a6b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9ee0e2508e7540f792c7a0dcdd853a6b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">快照复制</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/8d2ecdd5ea564ce58bef413e82f0b3fc" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">master执行依次bgsave，将内存中的数据快照到磁盘上。之后将快照文件传递到从节点。</span></span></li><li id="https://www.notion.so/a5088329cacb49f4b6aa38191283c945" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">从节点收到快照文件之后，清空内存中的数据。之后根据快照文件加载数据。加载完毕之后通知master进行增量同步。</span></span></li></ol><h2 id="https://www.notion.so/49a24b59450848d295cc52d9ca35af9f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/49a24b59450848d295cc52d9ca35af9f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">触发快照同步的场景</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/c9a9f292db7c4f12b1de12f6d08d412f" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">从节点是新上线的节点。</span></span></li><li id="https://www.notion.so/89bfd974de38455ca6a4ed152e43b13c" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">从节点由于下线或网络原因，导致快照同步期间的增量指令在buffer中被覆盖。</span></span></li></ol><h2 id="https://www.notion.so/0e14655bdb41445693af44ad96a4c075" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0e14655bdb41445693af44ad96a4c075"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">wait指令</span></span></h2><pre id="https://www.notion.so/59a37b4466cf456f93122bbdcf08e5dc" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>wait <span class="token operator">&lt;</span>等待的从库数量<span class="token operator">></span> <span class="token operator">&lt;</span>超时时间<span class="token operator">></span></span></span></span></code></pre><div id="https://www.notion.so/a658634459c04d2b9c6a93475798736d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上述命令将等待wait前的所有写操作同步到N个从库之后才返回，最多等待时间为超时时间。（如果超时时间为0则无限等待）</span></span></p></div><h2 id="https://www.notion.so/e4407bee509540e4bcedd637913d0cf1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/e4407bee509540e4bcedd637913d0cf1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">psync命令</span></span></h2><div id="https://www.notion.so/39a9fab3720f4e78a8e67bf4977b79de" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">新版redis增加了psync命令，避免从节点每次断线重连之后都需要重新进行快照同步。（断线重连需要先执行快照同步，但是主从节点实际差异可能很小，使用快照同步效率很低。）</span></span></p></div><h2 id="https://www.notion.so/b9bbce0f245744d08eb46adbdf235a82" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b9bbce0f245744d08eb46adbdf235a82"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">心跳检测</span></span></h2><div id="https://www.notion.so/48f86da3beed444fa767411afd1c95f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">默认情况下，从服务器每隔一秒会向主服务器发一条命令：</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">replconf ack &lt;replication_offset&gt;</code></span></span></p></div><div id="https://www.notion.so/92c0179c7ec14f3d87121749df88b8da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">心跳检测的作用：</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/c19a705015da45a28311181543f474a6" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">检测主从服务器之间的网络连接</span></span></li><li id="https://www.notion.so/e92c80601a1d46e091825a413796a84a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">辅助实现min-slaves。（保证写命令可以传递到足够多的从服务器）</span></span></li><li id="https://www.notion.so/61c4bef1e7fe4b85a5c8fdd43f827654" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">检测增量复制期间命令是否丢失。</span></span></li></ol><h2 id="https://www.notion.so/f336c0ef6d9a4ebe9fa1ac896e3ad92f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f336c0ef6d9a4ebe9fa1ac896e3ad92f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实践</span></span></h2><h3 id="https://www.notion.so/8fd450aae48c4fc681341ba1e53e63ef" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8fd450aae48c4fc681341ba1e53e63ef"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">服务器如何注册为从节点并进行主从复制</span></span></h3><div id="https://www.notion.so/5b7d908e8df8446ea0c7d02c10d55ed8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">执行命令将服务器注册为从节点。（执行该命令之后，从服务器将自动进行复制）</span></span></p></div><pre id="https://www.notion.so/09e18b17ff4f430d8c7feed29e76d009" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>slaveof <span class="token generics"><span class="token punctuation">&lt;</span>master_host<span class="token punctuation">></span></span> <span class="token generics"><span class="token punctuation">&lt;</span>master_port<span class="token punctuation">></span></span></span></span></span></code></pre><h3 id="https://www.notion.so/2d2abac3b9964e1284da14a219564832" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2d2abac3b9964e1284da14a219564832"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">旧版本复制命令的缺点</span></span></h3><div id="https://www.notion.so/462dbe9ab0cb4784978e594af28671dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从服务器对主服务器的复制可以分为两种情况：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/8a1cac6280234383a30ff0cde5dee28d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">初次复制</strong></span><span class="SemanticString">。从服务器没有复制过任何服务器 或者 要复制的服务器与之前复制的服务器不同</span></span></li><li id="https://www.notion.so/38aa20f631fc4d31baeaaad16c6e51ce" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">断线后重复制</strong></span><span class="SemanticString">。处于命令传播阶段的从服务器因为网络原因而中断，但从服务器自动重连连上了主服务器，并继续复制主服务器。</span></span></li></ol><div id="https://www.notion.so/67b08b66c84e48cfb0afd9f1a9de9cb6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">针对这两种情况，从服务器都是执行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync</code></span><span class="SemanticString">命令。该命令将首先进行快照复制，之后再进行增量复制。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/7f3ec5b6cc4149ca8ebf1cf71ced4ed7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对于初次复制，该命令可以很好地完成任务；</span></span></li><li id="https://www.notion.so/ec8a92fae37048c5b1709d461fd91d70" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">但是对于断线后重复制，可能从服务器与主服务器差异很小，重新执行快照复制的效率很低。其实可以通过执行增量复制来保持数据一致。</span></span></li></ul><h3 id="https://www.notion.so/a408579326f549a7892e0c717448533c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/a408579326f549a7892e0c717448533c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">新版本复制命令</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/1012eaefd73e40e1871f55281264b174" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果slave之前没有复制过，或者执行过</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">slaveof no one</code></span><span class="SemanticString"> ，那么将执行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">psync ？ -1</code></span><span class="SemanticString">全量复制。</span></span></li><li id="https://www.notion.so/b2316a3b83a846e58e06580bf4155c5b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果slave之前复制过某个master，那么slave将执行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">psync &lt;master_runid&gt; &lt;offset&gt;</code></span><span class="SemanticString"> 。之后master将判断runid是否匹配，以及offset对应的数据是否被覆盖。从而决定是全量复制还是增量复制。</span></span></li></ul><pre id="https://www.notion.so/04943dcc50f1428f8b0b2afde22b0e73" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// 可以通过这条命令获取master的runid和从节点的offset</span>
info replication</span></span></span></code></pre><h1 id="https://www.notion.so/ad538dd0fedc40b6946aaec8abd35663" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/ad538dd0fedc40b6946aaec8abd35663"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">哨兵机制</span></span></h1><div id="https://www.notion.so/2b5453417af74354bd57fd8f7bb6acc9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">作用</strong></span></span></p></div><div id="https://www.notion.so/3bec6bb40f6844f5b94c6b7bf83be493" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">检测主从节点的健康。主节点挂掉之后，自动选择一个最优的从节点并切换为主节点。</span></span></p></div><div id="https://www.notion.so/00089ffc8bba40629c2420d8e13c616c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">客户端连接时，首先连接sentinel，通过sentinel查询主节点的地址。主节点发生故障时，客户端会重新向sentinel要地址。</span></span></p></div><div id="https://www.notion.so/fe0392effcc44c649dc8c2790376a336" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">消息丢失</strong></span></span></p></div><div id="https://www.notion.so/d9d08fc9a9534e7d8efb388734bfb357" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">无法保证信息完全不丢失，只能保证信息尽可能少丢失。</span></span></p></div><div id="https://www.notion.so/eff892e8d96f4b758b7089673f9cdef5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有2个选项可以限制主从延迟过大：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/c8d769ca4c864d9abfa196b995e0fe52" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-to-write</code></span><span class="SemanticString"> ：最少有</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-to-write</code></span><span class="SemanticString"> 个节点在正常复制，否则就停止对外的写服务。</span></span></li><li id="https://www.notion.so/427f601df8cf480eb600570aa099ee8a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-max-lag</code></span><span class="SemanticString"> ：超过</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-max-lag</code></span><span class="SemanticString"> 秒没有收到从节点反馈，就认为该节点不能正常复制。</span></span></li></ul><h2 id="https://www.notion.so/67bf88245b4a4e0fbb77987679a23c75" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/67bf88245b4a4e0fbb77987679a23c75"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">sentinel获取主服务器的信息</span></span></h2><div id="https://www.notion.so/2e6c4c524b674b1e851e134360a869fa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">默认情况下，sentinel每隔10秒向被监视的主服务器发送info命令，并通过收到的info命令回复获取主服务器的当前信息。主服务器的信息包括两方面：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/3f8badf7cbdc422c9676db9d10079582" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">主服务器自身的信息</span></span></li><li id="https://www.notion.so/de68d63db06c40599f4c196011a0e9c1" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">主服务器下属的从服务器的信息</span></span></li></ol><h2 id="https://www.notion.so/2e54c48914d44eb1b3223ea77ae72067" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2e54c48914d44eb1b3223ea77ae72067"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">sentinel获取从服务器的信息</span></span></h2><div id="https://www.notion.so/a03fae8315804129b84a0b7c0b649041" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">默认情况下，sentinel每隔10秒会向从服务器发送info命令，并解析收到的info命令回复获取从服务器的信息。</span></span></p></div><h2 id="https://www.notion.so/9a37355ecc3d44998d6baec179858f5c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9a37355ecc3d44998d6baec179858f5c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">sentinel从主、从服务器获取频道信息</span></span></h2><div id="https://www.notion.so/a0bf774a97b045b287e01a934cdda4cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">默认情况下，sentinel每隔2秒会向主、从服务器发送publish命令，命令包含sentinel信息和主服务器的信息。</span></span></p></div><div id="https://www.notion.so/3c7ae65613e841c9922e87668f6b1454" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F76837364-465e-4a01-a1f3-54ca14445af7%2FUntitled.png?width=2605&amp;table=block&amp;id=3c7ae656-13e8-41c9-922e-87668f6b1454"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F76837364-465e-4a01-a1f3-54ca14445af7%2FUntitled.png?width=2605&amp;table=block&amp;id=3c7ae656-13e8-41c9-922e-87668f6b1454" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/8b8d833971fa4b1594329bae1f1309ce" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8b8d833971fa4b1594329bae1f1309ce"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">更新sentinel的字典</span></span></h3><div id="https://www.notion.so/62d5aeab05a5401f9a620f96cf025d14" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">sentinel中存在master示例，该实例存储master的相关属性。master中有一个sentinel字典，该字典包括：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/05f0bf67baaa4553b12b504a62ded236" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">sentinel自身的信息</span></span></li><li id="https://www.notion.so/e8e554d4f5314afebcaebe9a145b8f0e" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">监视该master的其他sentinel的信息</span></span></li></ol><div id="https://www.notion.so/fd6329ebcb614cd9bd97b15d476687e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">每收到一条频道信息，目标sentinel会提取出源sentinel信息，并更新源sentinel对应的数据结构。（如果不存在则创建）</span></span></p></div><div id="https://www.notion.so/c20b3096e73a4ce2a72fdca7d3532df9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">监视同一个master的sentinel可以互相发现对方。</strong></span></span></p></div><h3 id="https://www.notion.so/e41cb7666e3146e1a02da2157b1e393b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e41cb7666e3146e1a02da2157b1e393b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">创建连接其他sentinel的命令连接</span></span></h3><div id="https://www.notion.so/d2eb34a634ed4fa98a2c9002002e66e1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当sentinel通过频道信息收到一个新的sentinel时：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/057f75977664481ab0c541dff663dade" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">创建一个sentinel实例。</span></span></li><li id="https://www.notion.so/b48b12e3b7ee445e919b099a4b7ebfa2" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">创建一个指向该sentinel的命令连接。(主要用于实现主、客观下线)</span></span></li></ol><div id="https://www.notion.so/4aeb0efc94064217add3c1ee7608231c" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9b56d2e8-6269-4001-a820-390f826cef53%2FUntitled.png?width=576&amp;table=block&amp;id=4aeb0efc-9406-4217-add3-c1ee7608231c"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9b56d2e8-6269-4001-a820-390f826cef53%2FUntitled.png?width=576&amp;table=block&amp;id=4aeb0efc-9406-4217-add3-c1ee7608231c" style="width:576px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/3ec70d40d7a844d3a01b0b014f42151c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3ec70d40d7a844d3a01b0b014f42151c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">故障转移的流程</span></span></h2><div id="https://www.notion.so/bed60a49a8d6413c996aded3980e1481" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">主观下线</strong></span></span></p></div><div id="https://www.notion.so/162d3515ef944f729c1e7d1036638bd4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">down_after_milliseconds</code></span><span class="SemanticString">配置主观下线时间</span></span></p></div><div id="https://www.notion.so/483635d34fcb48388de634a08032cd4b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">down_after_milliseconds</code></span><span class="SemanticString"> 内未收到从主、从服务器、同样监视master的其他sentinel的响应，则认为该服务器主观下线。</span></span></p></div><div id="https://www.notion.so/5dbd81115ff848648c913402433f40dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">客观下线</strong></span></span></p></div><div id="https://www.notion.so/71284512a79649689618753a1c658079" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果sentinel判断master主观下线，就会询问监视该master的其他sentinel，确认它们是否也认为master已下线。</span></span></p></div><div id="https://www.notion.so/1953596619ab48b6aa92553e5a476792" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">sentinel如果收到足够多的已下线判断，就会将master判定为客观下线，并开始执行故障迁移工作。</span></span></p></div><div id="https://www.notion.so/99eb63f174fa49e8964fe1d899245081" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">选举领头sentinel</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/ea19e5504b2744118259c02b43fcf6ca" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">所有发现master客观下线的sentinel都会向其他所有sentinel发送命令，请求将自己设置为局部领头sentinel。</span></span></li><li id="https://www.notion.so/7113f79cca774a91b605142e95f66279" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">目标sentinel会按照先到先得的原则，将收到的第一个命令的源sentinel设置为局部领头sentinel，并发送响应。</span></span></li><li id="https://www.notion.so/77ef7c3bc6664b13a316dd2dcae29d11" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">领头sentinel需要半数以上的sentinel的支持。</span></span></li><li id="https://www.notion.so/c0c123f3a201473fb33376a95994a323" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">如果本轮选举失败，那么会在一段时间之后再次进行选举。</span></span></li></ol><div id="https://www.notion.so/1102f4632f9645799d8c9c7382cbd290" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">故障迁移（由领头sentinel执行）</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/6e0a1cced8a241958c2888936ee9d101" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">在已下线的master的slave中，选择一个最佳的slave，将其转化为master。选取规则：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/8520f0b8dd72400caad75ac0b503a50e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">首先剔除已下线的、长时间没有回复领头sentinel的、长时间与master断开连接的</span></span></li><li id="https://www.notion.so/aa5b0db79136406aae69f228578c834e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">按照优先级、偏移量、runid的排序，选择最优的</span></span></li></ul></li><li id="https://www.notion.so/4a634df96eab4d7b9247df9474b64140" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">让已下线master的所有slave改为复制新master</span></span></li><li id="https://www.notion.so/1bb4e5f0a876472b835096439dbbee8f" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">将已下线master设置为新master的slave，这样已下线的slave一上线，就会称为新master的slave。</span></span></li></ol><h2 id="https://www.notion.so/6497ca4196254672920ff78abc8323c7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6497ca4196254672920ff78abc8323c7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实践（搭建sentinel集群，并模拟主节点下线的情况）</span></span></h2><h3 id="https://www.notion.so/4899d03e4817476f80e044cf8ab95fe5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4899d03e4817476f80e044cf8ab95fe5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">准备</span></span></h3><div id="https://www.notion.so/ea38278131e146df9d7a9df66bbaae54" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc8e24187-e17a-4923-af5a-755e2f1d61e6%2FUntitled.png?width=1200&amp;table=block&amp;id=ea382781-31e1-46df-9d7a-9df66bbaae54"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc8e24187-e17a-4923-af5a-755e2f1d61e6%2FUntitled.png?width=1200&amp;table=block&amp;id=ea382781-31e1-46df-9d7a-9df66bbaae54" style="width:1200px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/40e13aed36594d1db9d01dc48cc3884e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe84a19f1-7fcf-4354-98d4-cc78890504f4%2FUntitled.png?width=1254&amp;table=block&amp;id=40e13aed-3659-4d1d-b9d0-1dc48cc3884e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe84a19f1-7fcf-4354-98d4-cc78890504f4%2FUntitled.png?width=1254&amp;table=block&amp;id=40e13aed-3659-4d1d-b9d0-1dc48cc3884e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/80c2cb657e274ad0811072c11c24a376" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上图所示，启动三个redis服务节点。其中一个主节点master、两个从节点slave1和slave2。</span></span></p></div><div id="https://www.notion.so/960f43de18e84dc89f6c35961e2ec77b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">启动三个sentinel节点，配置文件只需要修改下面两行</span></span></p></div><pre id="https://www.notion.so/3e4b147684204612b747a6f1b71b22aa" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// 让sentinel寻找 主机名 为master 端口为6379的master</span>
sentinel monitor mymaster master <span class="token number">6379</span> <span class="token number">2</span>
<span class="token comment">// 让sentinel解析master对应的ip地址，而不是直接将master当作ip</span>
SENTINEL resolve<span class="token operator">-</span>hostnames yes</span></span></span></code></pre><div id="https://www.notion.so/535a68a724b249e5a7760915a2a39d91" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（将6个container加入同一个network，之后即可使用容器名作为主机名互相访问）</span></span></p></div><div id="https://www.notion.so/e876bee7cd534e59bd4578ac0e16d4ce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">查看sentinel状态</strong></span></span></p></div><div id="https://www.notion.so/bed8fcfeabca4a2d8ada8e543ed49479" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">任选一个sentinel，进入redis-cli，执行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">info sentinel</code></span><span class="SemanticString">命令</span></span></p></div><div id="https://www.notion.so/9ba4d69fdbcc4002bf85f8bc2cc931cf" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F32eb9a96-4299-445a-98fe-2172dd1f3254%2FUntitled.png?width=1238&amp;table=block&amp;id=9ba4d69f-dbcc-4002-bf85-f8bc2cc931cf"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F32eb9a96-4299-445a-98fe-2172dd1f3254%2FUntitled.png?width=1238&amp;table=block&amp;id=9ba4d69f-dbcc-4002-bf85-f8bc2cc931cf" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/6f0573c3b6da4903a1b6000ab7769147" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看到master节点状态正常，有两个从节点，三个sentinel</span></span></p></div><h3 id="https://www.notion.so/5339c40e6fcd41558007ce56fa0bd2f6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/5339c40e6fcd41558007ce56fa0bd2f6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">强制master节点下线</span></span></h3><div id="https://www.notion.so/e5a11caecbd14cac87131cb36f35a4c0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">执行如下命令，强制master节点下线</span></span></p></div><div id="https://www.notion.so/18547422b1244b6096790e348f7cfb8d" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F27eab23a-2832-4d03-a711-b14ed1377f6b%2FUntitled.png?width=598&amp;table=block&amp;id=18547422-b124-4b60-9679-0e348f7cfb8d"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F27eab23a-2832-4d03-a711-b14ed1377f6b%2FUntitled.png?width=598&amp;table=block&amp;id=18547422-b124-4b60-9679-0e348f7cfb8d" style="width:598px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/2c25689e6eb745d2b77e7e677faebabb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">查看sentinel1的日志</span></span></p></div><div id="https://www.notion.so/3ce870ee88024a8cb90140721045d8cb" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F43b37cda-0b08-4edc-ad4b-70b180714adf%2FUntitled.png?width=912&amp;table=block&amp;id=3ce870ee-8802-4a8c-b901-40721045d8cb"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F43b37cda-0b08-4edc-ad4b-70b180714adf%2FUntitled.png?width=912&amp;table=block&amp;id=3ce870ee-8802-4a8c-b901-40721045d8cb" style="width:912px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/41161973eb7b4a908628b7207fd89886" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看到，sentinel检测到主节点客观下线，就会投票选择一个领头sentinel，领头sentinel选择一个从节点作为新的主节点。</span></span></p></div><div id="https://www.notion.so/cfc666e34b8d47baa413df4df2c9d8d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">切换后的master节点的IP和端口也会被写入配置文件</strong></span></span></p></div><div id="https://www.notion.so/5a8ae0689bdc4de3b25b8a6c212f9bbd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">一个sentinel可以监控多个master节点</strong></span></span></p></div><h2 id="https://www.notion.so/d5a4e9c76c394fd7afb8afd97e9607f4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d5a4e9c76c394fd7afb8afd97e9607f4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">sentinel应该至少被部署三个</span></span></h2><div id="https://www.notion.so/82687e00c4c64de4a8da94da2139306d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">部署两个sentinel的情况</strong></span></span></p></div><div id="https://www.notion.so/250f146d0f434d0ba41a4c3313bc94e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，假如M1和S1挂掉，那么S2可以检测到M1的客观下线。但是选举领头sentinel需要大于一半（2个）的sentinel的同意，此时只剩一个sentinel，无法进行故障迁移。</span></span></p></div><div id="https://www.notion.so/71ba17c8431b4d85891d93f6abdc0df7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">为什么一定要保证领头sentinel超过一半的sentinel同意？</strong></span></span></p></div><div id="https://www.notion.so/177e79c39456412c8ed3a421fcb3e9d7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不超过半数，那么一部分sentinel将M1视为主节点，另一部分sentinel将M2视为主节点。进而写操作也在不同的节点上执行。</span></span></p></div><div id="https://www.notion.so/166582b51f5b40a29be8bb627f5f5abc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">三个sentinel的一种异常情况</strong></span></span></p></div><div id="https://www.notion.so/f0e11fd88c2c47199dabffe053e6b61d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，M1与M2、R1断开连接了。M2和R1中选出了新的主节点。但是C1仍然可以连接M1，C1后续都会写入原来的M1上，进而造成数据丢失。</span></span></p></div><div id="https://www.notion.so/1043baad76534242a26dd76ba9cdea84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">解决办法</strong></span></span></p></div><div id="https://www.notion.so/1843f74d66174a1ead34ca1be8d87fce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以配置</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-to-write</code></span><span class="SemanticString">和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-max-lag</code></span><span class="SemanticString">两个属性。如果正常连接的从节点个数小于前者，主节点将拒绝写入。如果</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-max-lag</code></span><span class="SemanticString"> 秒内没有收到响应，则该节点为非正常节点。</span></span></p></div><div id="https://www.notion.so/2a652513eabb45b0b3003954ad37af77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">将</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-to-write = 1</code></span><span class="SemanticString"> ，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">min-slaves-max-lag = 10</code></span><span class="SemanticString"> 可以解决这个问题。这样在网络断开之后，C1最多可以写10秒，避免丢失过多的数据。</span></span></p></div><h1 id="https://www.notion.so/de71e34cf0164aac84deb356f5eb882f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/de71e34cf0164aac84deb356f5eb882f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">集群</span></span></h1><div id="https://www.notion.so/a832acb9a5b947a6a02f191a1d5c8898" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd168fb26-f5b5-4bd0-a2e1-7c55b329d4d6%2FUntitled.png?width=528&amp;table=block&amp;id=a832acb9-a5b9-47a6-a02f-191a1d5c8898"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd168fb26-f5b5-4bd0-a2e1-7c55b329d4d6%2FUntitled.png?width=528&amp;table=block&amp;id=a832acb9-a5b9-47a6-a02f-191a1d5c8898" style="width:528px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/6ae5b9cebf324b5a90d19c94cd2bed16" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Redis 将所有数据划分为16384（</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="2^{14}"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>14</mn></msup></mrow><annotation encoding="application/x-tex">2^{14}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="SemanticString">）个槽。</span></span></li><li id="https://www.notion.so/a31878ab837d4258af703dd563373cd7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">槽位信息会保存在每个Node中，不必分布式存储来存储槽位信息。</span></span></li><li id="https://www.notion.so/e99de0656c9343ad94736f7e1eb7c15d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Redis cluster客户端连接集群时，会得到槽位信息。</span></span></li></ul><div id="https://www.notion.so/ad7ef07aab1b4c3eafbaa94ebf3e9b0d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">槽位定位算法</strong></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/a240cb2579194bd3892ce23c48df4418" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">首先对key使用chr32算法进行hash得到一个整数值。</span></span></li><li id="https://www.notion.so/a83a0143f5d246a7b7002de1b7a981bb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">之后用该整数值对16384取模从而得到具体槽位。</span></span></li></ol><div id="https://www.notion.so/5dac30c5718143ca9e59f9e22ec1cade" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">跳转</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/84f8212a3779446698c16859236fac12" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果客户端向错误的节点发送指令，那么节点将返回Moved命令，格式为</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">moved &lt;槽位号&gt; &lt;目标节点地址&gt;</code></span></span></li><li id="https://www.notion.so/e5ed37af87114800a9902065176baafa" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">客户端收到moved命令后，会更新本地的槽位表信息并重新发送指令。</span></span></li><li id="https://www.notion.so/c4e49882785a4b0e934c61e42d35fbba" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">（该过程是自动进行的）</span></span></li></ul><div id="https://www.notion.so/1eb5045af22644ee89d849836b39c0a9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Node的迁移</strong></span></span></p></div><div id="https://www.notion.so/e1b7f268edb6409eab8d2dcce730eb8c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以将Node上的一部分槽位绑定到另一个Node上。此时需要将槽位对应的键也迁移到目标槽位上。</span></span></p></div><div id="https://www.notion.so/a1ae48290077489cb9279ff05b30ed65" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">迁移过程中的一次查询流程可能如下所示：</span></span></p></div><div id="https://www.notion.so/fdeac6a1baa1431a9b4312648f7c6a0a" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0bf1f063-4bd3-4f7f-a6fa-862b4769f30b%2FUntitled.png?width=576&amp;table=block&amp;id=fdeac6a1-baa1-431a-9b43-12648f7c6a0a"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0bf1f063-4bd3-4f7f-a6fa-862b4769f30b%2FUntitled.png?width=576&amp;table=block&amp;id=fdeac6a1-baa1-431a-9b43-12648f7c6a0a" style="width:576px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/98f120a6082b46e7a794250b394da9b0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">客户端首先向A发起查询，A没有查到对应的key。但是A正在执行迁移，可能key已经被迁移到了B上。因此A返回ask指令，让客户端向B查询。</span></span></li><li id="https://www.notion.so/660fe6d8544945e8bfdb19c67d611337" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">客户端首先向B发起一条asking命令。（因为此时迁移没有完成，直接向B查询将收到MOVED错误。所以需要先发一条asking命令，告诉B要处理下一条指令。）</span></span></li></ol><ul class="BulletedListWrapper"><li id="https://www.notion.so/0ecb8b4ce5be4b4e903097ce60b5a5af" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每个key的迁移都是同步的，迁移每个key的过程中主线程不能运行。因此在集群中要避免大key的产生。</span></span></li></ul><h2 id="https://www.notion.so/d75cf76741264a76b7748554090478e6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d75cf76741264a76b7748554090478e6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实践</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/5e0b6be8633a41dab00d6a45a332cca7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">redis根据</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cluster_enabled</code></span><span class="SemanticString"> 决定是否开启集群模式并称为其中的一个节点</span></span></li><li id="https://www.notion.so/89468301a5e848a49b90ea61f9569b57" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">redis-cli -c </code></span><span class="SemanticString"> 可以连接集群中的节点</span></span></li><li id="https://www.notion.so/02896bfefb4e4d6b9f9e51fe100a7004" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cluster meet &lt;ip&gt; &lt;port&gt;</code></span><span class="SemanticString"> 可以使用该命令连接其他节点</span></span></li></ul><div id="https://www.notion.so/6b8033bb122c45aca88a8287ba359737" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc319f9f1-82b9-4ad3-8a12-04a6a1481ee4%2FUntitled.png?width=912&amp;table=block&amp;id=6b8033bb-122c-45ac-a88a-8287ba359737"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc319f9f1-82b9-4ad3-8a12-04a6a1481ee4%2FUntitled.png?width=912&amp;table=block&amp;id=6b8033bb-122c-45ac-a88a-8287ba359737" style="width:912px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/b750c28a85a4464db99bb451c05545b9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cluster addslots &lt;slot&gt;...</code></span><span class="SemanticString"> 用于给节点分配槽。</span></span></li></ul><div id="https://www.notion.so/e7b12822208245d48d178e47e2e5b7c2" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fedc068d4-e80a-4bee-9d55-2f147271f417%2FUntitled.png?width=912&amp;table=block&amp;id=e7b12822-2082-45d4-8d17-8e47e2e5b7c2"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fedc068d4-e80a-4bee-9d55-2f147271f417%2FUntitled.png?width=912&amp;table=block&amp;id=e7b12822-2082-45d4-8d17-8e47e2e5b7c2" style="width:912px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/0ee910eb8b8e4a608ae1cc49efd29bb0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以为主节点设置从节点，从而增加容错率。从节点执行 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cluster replicate &lt;node_id&gt;</code></span><span class="SemanticString"> 即可注册为某个主节点的从节点。</span></span></li></ul><div id="https://www.notion.so/1b4e530bfe1749b9a8e111d0dbc54904" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Docker中以集群的方式启动Redis
</strong></span><span class="SemanticString">重写redis.conf文件，修改下面一行。</span></span></p></div><pre id="https://www.notion.so/d7a9221940c24caea4d1ba4f51dc68e9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>// 让redis以集群的方式运行
cluster-enabled yes</span></span></span></code></pre><div id="https://www.notion.so/1cf2a22ac9df4168acfcb52595b0cd2d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">之后运行新构建的镜像即可。</span></span></p></div><div id="https://www.notion.so/d4cfe0326fab45ba9995f82c96464cc4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">执行cluster meet时不能解析docker的container名为主机名</strong></span></span></p></div><div id="https://www.notion.so/61e99439f4224009b4b5a5e7e549aa1e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以将多个node运行在同一个container中</span></span></p></div><div id="https://www.notion.so/31530ec8d17e45c4a56bc33b7d3154c6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">给node分配槽</strong></span></span></p></div><div id="https://www.notion.so/b276ddcddb0049d4b687d4005a4ccdd1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以使用如下命令为node分配槽</span></span></p></div><pre id="https://www.notion.so/65395327f19749f2905e1d6addadad33" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>// 这里的区间为<span class="token punctuation">[</span>start, end<span class="token punctuation">]</span>
redis-cli -p <span class="token operator">&lt;</span>端口<span class="token operator">></span> -c cluster addslots <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> start end<span class="token variable">)</span></span> </span></span></span></code></pre><div id="https://www.notion.so/5efdb0a28ad048a6aee9d089236c7350" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">将所有节点分配完毕就可以执行写入操作了。</span></span></p></div><div id="https://www.notion.so/cbab041088714b55801f1fcc5b404705" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">迁移slot</strong></span></span></p></div><pre id="https://www.notion.so/addaa1f921b242578c89545f01f4c53a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>redis-cli -c CLUSTER SETSLOT <span class="token operator">&lt;</span>slots_to_be_migrated<span class="token operator">></span> IMPORTING <span class="token operator">&lt;</span>src_node_id<span class="token operator">></span></span></span></span></code></pre><div id="https://www.notion.so/5db5d7798e4844239cb3a4c56caf7582" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; Junying Shao&#39;s Blog 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>