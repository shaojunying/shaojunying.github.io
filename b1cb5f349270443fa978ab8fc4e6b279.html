<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>多路IO复用&nbsp;|&nbsp;Junying Shao&#39;s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="多路IO复用">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🔊&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🔊&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">多路IO复用</h1>
    
      <div class="DateTagBar">
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Linux.html">Linux</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/b1cb5f349270443fa978ab8fc4e6b279" class="PageRoot"><h2 id="https://www.notion.so/0db8479c824e44d5aa87d601b4c338aa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0db8479c824e44d5aa87d601b4c338aa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">IO的演化</span></span></h2><h3 id="https://www.notion.so/bd6f2be4afd448a0a21fff17d0f6b983" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/bd6f2be4afd448a0a21fff17d0f6b983"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">阻塞IO</span></span></h3><div id="https://www.notion.so/9811349819f84e619b8400c6594ba78d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用read函数之后将阻塞，直到有数据到达之后，函数将继续向下执行。</span></span></p></div><div id="https://www.notion.so/7818057490a640f89a79b08c8257dee0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/7567757da3634eaf9b4147f2d9da512a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调用read函数之后，线程将一直被阻塞，将不能处理别的请求。</span></span></li><li id="https://www.notion.so/20e4a2e587cd4d97a0de6e4d790d0a14" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以通过多线程的方式来解决这个问题，但是每个线程仍然在被阻塞，浪费CPU的时间片</span></span></li></ul><h3 id="https://www.notion.so/0b9dabf82f4f473d8f8fc2de78c2f376" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0b9dabf82f4f473d8f8fc2de78c2f376"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">非阻塞IO</span></span></h3><div id="https://www.notion.so/357f813335544df3a9d6adc0527dd2ae" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8a5aeed-1e34-4c48-8958-04ed28d477f5%2FUntitled.png?width=864&amp;table=block&amp;id=357f8133-3554-4df3-a9d6-adc0527dd2ae"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8a5aeed-1e34-4c48-8958-04ed28d477f5%2FUntitled.png?width=864&amp;table=block&amp;id=357f8133-3554-4df3-a9d6-adc0527dd2ae" style="width:864px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/4fd74e1362874133b5a64ea9ccb9f7e7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，对于非阻塞IO，系统可以轮询调用，判断哪些文件描述符已就绪，就绪的话就对其进行处理。（但是这里对每个文件描述符都需要进行一次系统调用，造成了系统资源的浪费。）</span></span></p></div><h3 id="https://www.notion.so/af7c7f9b6dee4080a5208b16b97b10b0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/af7c7f9b6dee4080a5208b16b97b10b0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">IO多路复用</span></span></h3><div id="https://www.notion.so/c600b0542ab64b4cb886fbd34e17d181" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">IO多路复用就是将上面的用户态的遍历转移到了内核态，这样的话，系统调用就从原来的N次减少到了1次，可以极大地避免计算资源的浪费。</span></span></p></div><h2 id="https://www.notion.so/cc2d5968d04548ff94c881d2369102da" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cc2d5968d04548ff94c881d2369102da"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">多路IO复用效率高的原因</span></span></h2><div id="https://www.notion.so/1ae9339e373c42a096e58c2592436b53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多路IO复用通过一次系统调用，之后内核将遍历所有的事件描述符，找出所有的就绪事件。</span></span></p></div><div id="https://www.notion.so/a73ecd6c752d42bba964154529c7113d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不适用IO复用，那么只能使用非阻塞调用实现。需要在用户态遍历所有的事件描述符，需要对每一个事件描述符发起一个系统调用。相对来说效率更低。</span></span></p></div><h2 id="https://www.notion.so/6f29232f212f4aa6bf8f2997bb056def" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6f29232f212f4aa6bf8f2997bb056def"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">各种实现的优缺点</span></span></h2><div id="https://www.notion.so/677664e3800544fdb12400f9408800f3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">select、poll可移植性好；但是同时检查大量文件描述符时，性能延展性不高。</span></span></p></div><div id="https://www.notion.so/94b73c321c2f4b6b9ac520768d0d5a74" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">epoll可以高效检查大量文件描述符；但epoll是专属于Linux的API。</span></span></p></div><div id="https://www.notion.so/085333d94cf549469697c98be9b588f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Epoll相比于信号驱动IO的优点：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/840282668d474983925526a1b0a0b97b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">避免了处理信号的复杂性</span></span></li><li id="https://www.notion.so/e57ffd259fdb433eb566a1f08ce4c6cb" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">可以执行要监听的事件类型</span></span></li><li id="https://www.notion.so/86c8a8282f8f41e7842f6826f84c4640" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">可以选择水平触发或边缘触发。</span></span></li></ol><h2 id="https://www.notion.so/61d9ea3d5e7745b6a6c5f860510c6e21" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/61d9ea3d5e7745b6a6c5f860510c6e21"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">水平触发和边缘触发</span></span></h2><h3 id="https://www.notion.so/4d89ff8fc22949f0a8f5faeab686a62a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4d89ff8fc22949f0a8f5faeab686a62a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">水平触发</span></span></h3><div id="https://www.notion.so/884d8265d58f44609352a2d8e2ca1d20" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">水平触发：</strong></span><span class="SemanticString">如果文件描述符上可以非阻塞地执行IO系统调用，则认为该文件描述符已就绪。（任意时刻可以重复检查IO状态）</span></span></p></div><div id="https://www.notion.so/9081f0ab1af74b5cb3d4061803f57846" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于读事件：如果缓冲区中数据没有被处理完毕，那么将一直可以监听到可读信号。</span></span></p></div><div id="https://www.notion.so/02b82ab48fb24854a72eb827c710fe36" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于写事件：如果缓冲区没有满，那么将一直可以接收到可写信号。</span></span></p></div><pre id="https://www.notion.so/02649d0d9b9640a59c776a3f2151ef7c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> select
<span class="token keyword">import</span> socket

server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span>
port <span class="token operator">=</span> <span class="token number">8080</span>
<span class="token function">server_socket</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
server_socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
server_socket<span class="token punctuation">.</span><span class="token function">setblocking</span><span class="token punctuation">(</span>False<span class="token punctuation">)</span>

epoll <span class="token operator">=</span> select<span class="token punctuation">.</span><span class="token function">epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token punctuation">)</span>

connections <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">while</span> True<span class="token operator">:</span>
    events <span class="token operator">=</span> epoll<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span>
    # <span class="token keyword">break</span>
    # 如果这里直接<span class="token keyword">break</span>，不处理事件，那么epoll<span class="token punctuation">.</span>poll方法将会一直返回就绪的写事件。
    <span class="token keyword">for</span> file_no<span class="token punctuation">,</span> event <span class="token keyword">in</span> events<span class="token operator">:</span>
        <span class="token keyword">if</span> file_no <span class="token operator">==</span> server_socket<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到socket的可读的事件（有新的连接）"</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">,</span> address <span class="token operator">=</span> server_socket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">.</span><span class="token function">setblocking</span><span class="token punctuation">(</span>False<span class="token punctuation">)</span>
            connections<span class="token punctuation">[</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection
            # 监听连接上的可读事件
            # epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span> <span class="token operator">|</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLET</span><span class="token punctuation">)</span>
            epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token punctuation">)</span>
        elif event <span class="token operator">&amp;</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到可读事件"</span><span class="token punctuation">)</span>
            # 监听到可读事件
            connection <span class="token operator">=</span> connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span>
            request <span class="token operator">=</span> b<span class="token string">""</span>
            <span class="token keyword">try</span><span class="token operator">:</span>
                <span class="token keyword">while</span> True<span class="token operator">:</span>
                    buffer <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">:</span>
                        # 客户端已关闭连接
                        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"客户端已经关闭连接"</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
                    request <span class="token operator">+=</span> buffer
                    <span class="token keyword">break</span>
            except socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token operator">:</span>
                pass
            # 输出从客户端收到的请求
            <span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"request: {request}"</span><span class="token punctuation">)</span>
            # epoll<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLOUT</span> <span class="token operator">|</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLET</span><span class="token punctuation">)</span>
        elif event <span class="token operator">&amp;</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLOUT</span><span class="token operator">:</span>
            # 接收到可写事件
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到可写事件"</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> <span class="token string">"这是从服务端发送的响应"</span>
            connection <span class="token operator">=</span> connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span>
            connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            epoll<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>file_no<span class="token punctuation">)</span>
            connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
# server_socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><pre id="https://www.notion.so/d5194f1d6aab49f0bcdb8d45a8d4b6d0" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> socket
<span class="token keyword">import</span> time

client_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
port <span class="token operator">=</span> <span class="token number">8080</span>
client_socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
client_socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>b<span class="token string">"hello"</span><span class="token punctuation">)</span>
client_socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><h3 id="https://www.notion.so/d87367bd85074dfcb6651ef546ffcbb8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d87367bd85074dfcb6651ef546ffcbb8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">边缘触发</strong></span></span></h3><div id="https://www.notion.so/a9d0294a443e4121a57b4a27c3786a81" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">边缘触发：如果文件描述符自上次检查以来有了新的IO活动，则需要触发通知。</span></span></p></div><div id="https://www.notion.so/15808786ec7e4453a2d8367f8e2a0009" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于可读事件：从上次读事件之后，有了新的数据到达。</span></span></p></div><div id="https://www.notion.so/86c167b44c2b40919460f05158bf2a47" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于可写事件：从上次写事件之后，缓冲区由不可写变成可写或者缓冲区中有数据被发送出去。</span></span></p></div><h3 id="https://www.notion.so/e97f2b040756401ea43c5f6bbcee91cf" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e97f2b040756401ea43c5f6bbcee91cf"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">不同IO支持的IO类型</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/c7451ee380f943baaa68ee8feea29006" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Select、Poll：水平触发</span></span></li><li id="https://www.notion.so/8345b3c8d95b4d40bc7f8d3e634ca586" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">信号驱动IO：边缘触发</span></span></li><li id="https://www.notion.so/79429accfde3429c92e6d158b518e227" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Epoll：水平触发（默认）或边缘触发</span></span></li></ul><h2 id="https://www.notion.so/eb29dbc2edbe4326bb5576fee601c756" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/eb29dbc2edbe4326bb5576fee601c756"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Select</span></span></h2><h3 id="https://www.notion.so/58f3f450d0b2427ca5ab16cba1ad51d5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/58f3f450d0b2427ca5ab16cba1ad51d5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">代码</span></span></h3><pre id="https://www.notion.so/1f186d850dbd4276af57c417e477a05f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">time_val</span> <span class="token operator">*</span> timeout<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/0fdb8cfee52744a0b73824a1eb8c0c41" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上是select函数的定义。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/0c1c7d6ca794467897648f07e1e819d4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">返回值。0表示超时、-1表示错误，正整数则表示3个集合中就绪的文件描述符数量。</span></span></li><li id="https://www.notion.so/855b392679e04eca83e07dff7d355728" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">readfds、writefds、exceptfds传递要监听的文件描述符。三个变量分别监听输入是否就绪、输出是否就绪、异常。返回时，这三个结构体将会被修改，指向就绪的文件描述符。如果在循环中调用select，则需要每次调用之前重新初始化三个文件描述符集合。（这三个文件描述符底层都是定长数组，长度为1024）</span></span></li><li id="https://www.notion.so/51070629902845e7968326c85a084a14" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">timeout。表示select阻塞的时间上限。如果为NULL则一直阻塞，直到有文件描述符就绪。</span></span></li><li id="https://www.notion.so/e55d921e192345989b07ceb0ca5d3026" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">nfds。传递三个集合大小的最大值+1，避免无用的遍历，提高select的效率。</span></span></li></ul><h3 id="https://www.notion.so/538dfcc0f73745a2989c837da2f7bb54" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/538dfcc0f73745a2989c837da2f7bb54"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">过程</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/a415882ddccd402eb06e42c7dd7258e0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">使用一个定长数组保存要监听的文件描述符</span></span></li><li id="https://www.notion.so/37711e3062d94b54b91d0162936f3734" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">将数组从用户空间拷贝到内核空间</span></span></li><li id="https://www.notion.so/7af781012bdb45d0b0d1f680a63b0bba" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">内核空间轮询数组的各个元素，查看时间是否就绪。</span></span></li><li id="https://www.notion.so/f49e0aa53c0c4270ab2c5d6241af4193" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">select是一个可以通过函数参数控制等待时间</span></span></li></ul><h3 id="https://www.notion.so/ee5ee77be73d437aa9dfb6e8becf9386" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ee5ee77be73d437aa9dfb6e8becf9386"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">缺点</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/5053e727fc444a89a1057edeab7187f9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">数组长度是1024，所以最多可以监听1024个事件</span></span></li><li id="https://www.notion.so/67efdfe37b3347279ff4ef3901126a00" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每次调用select，需要将文件描述符列表从用户空间复制到内核空间</span></span></li><li id="https://www.notion.so/8219f241fbdf4b7cb5b93b09bd5acfe3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">需要轮询数组找就绪的事件，效率低下</span></span></li></ul><h2 id="https://www.notion.so/d5d43477591e4540b2e552747a3715e6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d5d43477591e4540b2e552747a3715e6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Poll</span></span></h2><h3 id="https://www.notion.so/a049fc38af214b0ea68a1a6c2f4b2a7a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/a049fc38af214b0ea68a1a6c2f4b2a7a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">函数</span></span></h3><pre id="https://www.notion.so/80612231699a403787a58e977010d8ed" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">poll_fd</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/efb525dfb4e0438cbbc12e9ee42dea53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">poll_fd 的结构如下所示</span></span></p></div><pre id="https://www.notion.so/273adb9288884a7db335c46490e27de5" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// 文件描述符</span>
	<span class="token keyword">short</span> events<span class="token punctuation">;</span> <span class="token comment">// 监听的事件</span>
	<span class="token keyword">short</span> revents<span class="token punctuation">;</span> <span class="token comment">// 返回的事件</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/d9d402facc144fb892a12c8a502cdfad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，在events传入要监听的事件，在函数返回之后查询revents即可查看就绪的事件。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/5dca62aa865c4ee7ad32d3b359cc3c03" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">nfds 传入的文件描述符数量</span></span></li><li id="https://www.notion.so/d59084aaf2934ac5995ef77142818b0e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">timeout：-1 表示阻塞、0表示只遍历1次。正整数则表示超时时间。</span></span></li><li id="https://www.notion.so/69438b71f4724fa1953f5da0378c67db" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">返回值：0表示超时、-1表示错误、正整数表示就绪的事件数。</span></span></li></ul><h2 id="https://www.notion.so/3611497b04834a2f9f97bfc4c06d5b6b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3611497b04834a2f9f97bfc4c06d5b6b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">select和poll的区别</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/1cafe14f1dbc4d5a90fafca14aa2c57d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">是否有文件描述符数量的限制。</span></span></li><li id="https://www.notion.so/ce895d595f5e4d9081742ca9f54070df" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">是否需要在每次调用之后重新构造fds。</span></span></li></ol><h2 id="https://www.notion.so/bbf8fdced7c749c9b7a057e260dd3d04" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/bbf8fdced7c749c9b7a057e260dd3d04"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">select和poll存在的问题</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/a8881a826926433ca4b788aa82470d70" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">每次调用都需要轮询所有文件描述符，效率较低。</span></span></li><li id="https://www.notion.so/5b8cf33e0472446a9e0aa8b67a6f39a5" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">每次调用需要在用户态和内核态之间来回拷贝数据。</span></span></li></ol><h2 id="https://www.notion.so/99ee9ca8961246bea923d36ae7a8f148" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/99ee9ca8961246bea923d36ae7a8f148"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Epoll</span></span></h2><div id="https://www.notion.so/42a83d45341b44938a3c5751cdc29ee2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Epoll也即event poll</span></span></p></div><h3 id="https://www.notion.so/f6a9d7ffcfa8439085579e704c5641c8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f6a9d7ffcfa8439085579e704c5641c8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">创建epoll实例</span></span></h3><pre id="https://www.notion.so/2c5b61d9a8eb407b982ce0fe78e8f34b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/1eff6a7420984d86a1b88890cf5fb14f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1eff6a7420984d86a1b88890cf5fb14f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">修改兴趣列表</span></span></h3><pre id="https://www.notion.so/322c1515316f4ed3b7b1c0c185fc24d3" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// epfd就是上面创建的epoll实例</span>
<span class="token comment">// op: 操作(添加、更新、删除)</span>
<span class="token comment">// fd: 要监听的文件描述符</span>
<span class="token comment">// ev: 是一个结构体，包含两个字段。events传递感兴趣的集合；data在fd成为就绪态之后用于指定传递给调用进程的信息。</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span> ev<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/2610735434874f99af54a5947b2b7f95" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2610735434874f99af54a5947b2b7f95"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">事件等待</span></span></h3><pre id="https://www.notion.so/bd4f2406ff654f5d84d17ac70dff175a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// evlist： 用于记录就绪的文件描述符信息</span>
<span class="token comment">// max_events：指定evlist包含的元素数量</span>
<span class="token comment">// 返回值：-1错误、0超时、正整数则表示就绪的文件描述符数量</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epid<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span> evlist<span class="token punctuation">,</span> <span class="token keyword">int</span> max_events<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/1b46c66c40714314bc7f24d0767dcd17" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1b46c66c40714314bc7f24d0767dcd17"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">过程</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/59b43137f8354fd9b1ac0764d2525186" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">文件描述符被注册之后，每当执行IO操作使文件描述符就绪时，内核就会在epoll的就绪列表中添加一个元素。</span></span></li><li id="https://www.notion.so/1d05e009a00c416d887ae42fa71ba586" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每次调用epoll_wait，就是从就绪列表中取元素。</span></span></li><li id="https://www.notion.so/ecf52aaa03f24cc48ae79e8c5e67947e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">epoll在内核中建立数据结构，每次只返回就绪的文件描述符，避免了重复复制大量的文件描述符。</span></span></li><li id="https://www.notion.so/b1692547d06e46a1a48f8f2d866bafa0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">epoll默认为水平触发，可以在调用epoll_ctl时将其设置为边缘触发。</span></span></li></ul><h2 id="https://www.notion.so/aed1004cc030498d881d60e6e125599c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/aed1004cc030498d881d60e6e125599c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">参考资料</span></span></h2><div id="https://www.notion.so/fce3b52b7bc2406aa4fb625210d6522d" class="PDF"><div class="PDF__Content"><embed width="192" height="96" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5521a144-bcf4-4f76-8554-88b77f5c7ff1%2FLinux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C%EF%BC%88%E4%B8%8B%E5%86%8C%EF%BC%89.pdf?table=block&amp;id=fce3b52b-7bc2-406a-a4fb-625210d6522d" type="application/pdf"/></div></div><div id="https://www.notion.so/f805cd72fb674fa89bf85215a5ab9a7c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&amp;mid=2247494866&amp;idx=1&amp;sn=0ebeb60dbc1fd7f9473943df7ce5fd95&amp;chksm=c2c5967ff5b21f69030636334f6a5a7dc52c0f4de9b668f7bac15b2c1a2660ae533dd9878c7c&amp;scene=178&amp;cur_album_id=1703494881072955395#rd">https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&amp;mid=2247494866&amp;idx=1&amp;sn=0ebeb60dbc1fd7f9473943df7ce5fd95&amp;chksm=c2c5967ff5b21f69030636334f6a5a7dc52c0f4de9b668f7bac15b2c1a2660ae533dd9878c7c&amp;scene=178&amp;cur_album_id=1703494881072955395#rd</a></span></span></p></div><div id="https://www.notion.so/0a4fb43670ca499291ff32167cd19c3d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; Junying Shao&#39;s Blog 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>