<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Copy of ,多路IO复用&nbsp;|&nbsp;Notablog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Copy of ,多路IO复用">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🔊&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🔊&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Copy of ,多路IO复用</h1>
    
  </header>
  <article id="https://www.notion.so/52a100b2a63c455c88aeced7741084e9" class="PageRoot"><h2 id="https://www.notion.so/e55a6480bee44afd9e76853fd892eede" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/e55a6480bee44afd9e76853fd892eede"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">IO的演化</span></span></h2><h3 id="https://www.notion.so/e5cd05c14c464e46b716ca7c06cf8357" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e5cd05c14c464e46b716ca7c06cf8357"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">阻塞IO</span></span></h3><div id="https://www.notion.so/29d1e9433161405597ae5485e16deae6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用read函数之后将阻塞，直到有数据到达之后，函数将继续向下执行。</span></span></p></div><div id="https://www.notion.so/579b7db204dc4d99ac6cecbe80f96c4a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">缺点</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/37fa406567964201b029258068b2619d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调用read函数之后，线程将一直被阻塞，将不能处理别的请求。</span></span></li><li id="https://www.notion.so/d862de5813f945cd9f9f35711bc22240" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以通过多线程的方式来解决这个问题，但是每个线程仍然在被阻塞，浪费CPU的时间片</span></span></li></ul><h3 id="https://www.notion.so/d015ec0716774765badb69fcab8eecac" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d015ec0716774765badb69fcab8eecac"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">非阻塞IO</span></span></h3><div id="https://www.notion.so/f1c16f8fb34249b58968cf9c40b3f903" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8a5aeed-1e34-4c48-8958-04ed28d477f5%2FUntitled.png?width=864&amp;table=block&amp;id=f1c16f8f-b342-49b5-8968-cf9c40b3f903"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa8a5aeed-1e34-4c48-8958-04ed28d477f5%2FUntitled.png?width=864&amp;table=block&amp;id=f1c16f8f-b342-49b5-8968-cf9c40b3f903" style="width:864px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9e8589b3100b4c709627d0601045cc4e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，对于非阻塞IO，系统可以轮询调用，判断哪些文件描述符已就绪，就绪的话就对其进行处理。（但是这里对每个文件描述符都需要进行一次系统调用，造成了系统资源的浪费。）</span></span></p></div><h3 id="https://www.notion.so/4d5d593f34374ccfafc014447af8a514" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4d5d593f34374ccfafc014447af8a514"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">IO多路复用</span></span></h3><div id="https://www.notion.so/2cdf4b1863e94a85a051f967645e5f2b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">IO多路复用就是将上面的用户态的遍历转移到了内核态，这样的话，系统调用就从原来的N次减少到了1次，可以极大地避免计算资源的浪费。</span></span></p></div><h2 id="https://www.notion.so/3e311e4b308d44ea941b9112b99d67c2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3e311e4b308d44ea941b9112b99d67c2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">多路IO复用效率高的原因</span></span></h2><div id="https://www.notion.so/2b00e42ab07f49f29ebece9dd58c5dc7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多路IO复用通过一次系统调用，之后内核将遍历所有的事件描述符，找出所有的就绪事件。</span></span></p></div><div id="https://www.notion.so/029e51ecda8943f09b2ee45d8c776d5c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不适用IO复用，那么只能使用非阻塞调用实现。需要在用户态遍历所有的事件描述符，需要对每一个事件描述符发起一个系统调用。相对来说效率更低。</span></span></p></div><h2 id="https://www.notion.so/e7f97116b6c34b7c8272e7200038073d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/e7f97116b6c34b7c8272e7200038073d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">各种实现的优缺点</span></span></h2><div id="https://www.notion.so/19d1ffea6ea24a148a53ec95bc669840" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">select、poll可移植性好；但是同时检查大量文件描述符时，性能延展性不高。</span></span></p></div><div id="https://www.notion.so/339faba9dc844e61825cf448866c0091" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">epoll可以高效检查大量文件描述符；但epoll是专属于Linux的API。</span></span></p></div><div id="https://www.notion.so/8a256b5f10814cb9b4c74279281e20b7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Epoll相比于信号驱动IO的优点：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/b58fe5326591417ba9ba01b16e2d34c7" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">避免了处理信号的复杂性</span></span></li><li id="https://www.notion.so/273d68170a924a32be5c540611f15f2b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">可以执行要监听的事件类型</span></span></li><li id="https://www.notion.so/ac0d175e84ed4004bcecba6aeef75094" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">可以选择水平触发或边缘触发。</span></span></li></ol><h2 id="https://www.notion.so/b1569c6071ed4491962bce6609f76f43" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b1569c6071ed4491962bce6609f76f43"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">水平触发和边缘触发</span></span></h2><h3 id="https://www.notion.so/40b6ccd9dccb444f8b8c115e68e4d630" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/40b6ccd9dccb444f8b8c115e68e4d630"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">水平触发</span></span></h3><div id="https://www.notion.so/7e7e52e6723f4d5a852e82cf9d0a1d30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">水平触发：</strong></span><span class="SemanticString">如果文件描述符上可以非阻塞地执行IO系统调用，则认为该文件描述符已就绪。（任意时刻可以重复检查IO状态）</span></span></p></div><div id="https://www.notion.so/dc290240bc034837abf64d19691d1fe2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于读事件：如果缓冲区中数据没有被处理完毕，那么将一直可以监听到可读信号。</span></span></p></div><div id="https://www.notion.so/89e726e97d8c4ee2aa80b95826dbc95b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于写事件：如果缓冲区没有满，那么将一直可以接收到可写信号。</span></span></p></div><pre id="https://www.notion.so/795dc57923f34b6186915718a38ab6c3" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> select
<span class="token keyword">import</span> socket

server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span>
port <span class="token operator">=</span> <span class="token number">8080</span>
<span class="token function">server_socket</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
server_socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
server_socket<span class="token punctuation">.</span><span class="token function">setblocking</span><span class="token punctuation">(</span>False<span class="token punctuation">)</span>

epoll <span class="token operator">=</span> select<span class="token punctuation">.</span><span class="token function">epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token punctuation">)</span>

connections <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">while</span> True<span class="token operator">:</span>
    events <span class="token operator">=</span> epoll<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span>
    # <span class="token keyword">break</span>
    # 如果这里直接<span class="token keyword">break</span>，不处理事件，那么epoll<span class="token punctuation">.</span>poll方法将会一直返回就绪的写事件。
    <span class="token keyword">for</span> file_no<span class="token punctuation">,</span> event <span class="token keyword">in</span> events<span class="token operator">:</span>
        <span class="token keyword">if</span> file_no <span class="token operator">==</span> server_socket<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到socket的可读的事件（有新的连接）"</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">,</span> address <span class="token operator">=</span> server_socket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">.</span><span class="token function">setblocking</span><span class="token punctuation">(</span>False<span class="token punctuation">)</span>
            connections<span class="token punctuation">[</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection
            # 监听连接上的可读事件
            # epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span> <span class="token operator">|</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLET</span><span class="token punctuation">)</span>
            epoll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token punctuation">)</span>
        elif event <span class="token operator">&amp;</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLIN</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到可读事件"</span><span class="token punctuation">)</span>
            # 监听到可读事件
            connection <span class="token operator">=</span> connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span>
            request <span class="token operator">=</span> b<span class="token string">""</span>
            <span class="token keyword">try</span><span class="token operator">:</span>
                <span class="token keyword">while</span> True<span class="token operator">:</span>
                    buffer <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">:</span>
                        # 客户端已关闭连接
                        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"客户端已经关闭连接"</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
                    request <span class="token operator">+=</span> buffer
                    <span class="token keyword">break</span>
            except socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token operator">:</span>
                pass
            # 输出从客户端收到的请求
            <span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"request: {request}"</span><span class="token punctuation">)</span>
            # epoll<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLOUT</span> <span class="token operator">|</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLET</span><span class="token punctuation">)</span>
        elif event <span class="token operator">&amp;</span> select<span class="token punctuation">.</span><span class="token constant">EPOLLOUT</span><span class="token operator">:</span>
            # 接收到可写事件
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"收到可写事件"</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> <span class="token string">"这是从服务端发送的响应"</span>
            connection <span class="token operator">=</span> connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span>
            connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            epoll<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>file_no<span class="token punctuation">)</span>
            connections<span class="token punctuation">[</span>file_no<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
# server_socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><pre id="https://www.notion.so/24e610d58ae94750a295dc71df4bda32" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> socket
<span class="token keyword">import</span> time

client_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
port <span class="token operator">=</span> <span class="token number">8080</span>
client_socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
client_socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>b<span class="token string">"hello"</span><span class="token punctuation">)</span>
client_socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><h3 id="https://www.notion.so/c9ff68abff774c07ac8ac3c664feed55" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c9ff68abff774c07ac8ac3c664feed55"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">边缘触发</strong></span></span></h3><div id="https://www.notion.so/95caf2557c6444f7995dfb9e78b93d0a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">边缘触发：如果文件描述符自上次检查以来有了新的IO活动，则需要触发通知。</span></span></p></div><div id="https://www.notion.so/64be56832e21462099366dd20abecb1f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于可读事件：从上次读事件之后，有了新的数据到达。</span></span></p></div><div id="https://www.notion.so/405f5e50cc8f454fb2ba5b5bf671e8d6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">对于可写事件：从上次写事件之后，缓冲区由不可写变成可写或者缓冲区中有数据被发送出去。</span></span></p></div><h3 id="https://www.notion.so/d9e87440cb2c4ac8a0a7d571adab087a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d9e87440cb2c4ac8a0a7d571adab087a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">不同IO支持的IO类型</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/d5459fde8b73424b9c4a8609f0f6ef80" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Select、Poll：水平触发</span></span></li><li id="https://www.notion.so/4f601c743fd44a2e86f4f54565f548a1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">信号驱动IO：边缘触发</span></span></li><li id="https://www.notion.so/f590e19ac55d4a8cbfa19123e361cf16" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Epoll：水平触发（默认）或边缘触发</span></span></li></ul><h2 id="https://www.notion.so/80e0f8f34f4e4a78b47fc255b6960c29" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/80e0f8f34f4e4a78b47fc255b6960c29"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Select</span></span></h2><h3 id="https://www.notion.so/6fe8d4c2928e400aa0377c2214557203" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/6fe8d4c2928e400aa0377c2214557203"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">代码</span></span></h3><pre id="https://www.notion.so/ec28a745dbb04141b09f1f05c97c4584" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span> exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">time_val</span> <span class="token operator">*</span> timeout<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/7f7f92e2efe844af96ad4d73cbe5f191" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上是select函数的定义。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/cfe105568372486c91fa995f5bee463d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">返回值。0表示超时、-1表示错误，正整数则表示3个集合中就绪的文件描述符数量。</span></span></li><li id="https://www.notion.so/ba54814f8b614da7aa5065a9a8ca21a9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">readfds、writefds、exceptfds传递要监听的文件描述符。三个变量分别监听输入是否就绪、输出是否就绪、异常。返回时，这三个结构体将会被修改，指向就绪的文件描述符。如果在循环中调用select，则需要每次调用之前重新初始化三个文件描述符集合。（这三个文件描述符底层都是定长数组，长度为1024）</span></span></li><li id="https://www.notion.so/5d78aaf79f3b47479cf36f8b64546d1a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">timeout。表示select阻塞的时间上限。如果为NULL则一直阻塞，直到有文件描述符就绪。</span></span></li><li id="https://www.notion.so/3456b99a686d4ba9877e59459458628f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">nfds。传递三个集合大小的最大值+1，避免无用的遍历，提高select的效率。</span></span></li></ul><h3 id="https://www.notion.so/bbf19fc0eb3b42148fad8daa721e188a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/bbf19fc0eb3b42148fad8daa721e188a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">过程</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/9d14f149abcc414ca1443a18654e4e63" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">使用一个定长数组保存要监听的文件描述符</span></span></li><li id="https://www.notion.so/b3696c2f4ad34225b260856f22e880eb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">将数组从用户空间拷贝到内核空间</span></span></li><li id="https://www.notion.so/f9586bfba5284b85a86aae5678893c80" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">内核空间轮询数组的各个元素，查看时间是否就绪。</span></span></li><li id="https://www.notion.so/171e82c226dd44a391b169e66e7d549a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">select是一个可以通过函数参数控制等待时间</span></span></li></ul><h3 id="https://www.notion.so/f80f669058eb468290c41d98b844ba43" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f80f669058eb468290c41d98b844ba43"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">缺点</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/f92fa2f8cfd346adafacb16614ecdbf4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">数组长度是1024，所以最多可以监听1024个事件</span></span></li><li id="https://www.notion.so/2f69f9932ed64dd1a4ba8297dce57f4f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每次调用select，需要将文件描述符列表从用户空间复制到内核空间</span></span></li><li id="https://www.notion.so/049b1b1b1bce407ea50a9bc2023218b6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">需要轮询数组找就绪的事件，效率低下</span></span></li></ul><h2 id="https://www.notion.so/bafc898163ee46cca1f1e6fd3b03e893" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/bafc898163ee46cca1f1e6fd3b03e893"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Poll</span></span></h2><h3 id="https://www.notion.so/1729c4ac789c47b08a26922a9c2cee82" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1729c4ac789c47b08a26922a9c2cee82"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">函数</span></span></h3><pre id="https://www.notion.so/b0bf297acd864f89bddcbd88eee1f5a8" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">poll_fd</span> fds<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/027ab082cbb844d099ae0546d3ef6bd1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">poll_fd 的结构如下所示</span></span></p></div><pre id="https://www.notion.so/c51084b4eb604e519dd5cb1159751b46" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// 文件描述符</span>
	<span class="token keyword">short</span> events<span class="token punctuation">;</span> <span class="token comment">// 监听的事件</span>
	<span class="token keyword">short</span> revents<span class="token punctuation">;</span> <span class="token comment">// 返回的事件</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/508e932f5a594b5fb84868c17d5d9a35" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上所示，在events传入要监听的事件，在函数返回之后查询revents即可查看就绪的事件。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/6a7c46cb40c14a48b337df4269b0e0be" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">nfds 传入的文件描述符数量</span></span></li><li id="https://www.notion.so/c9a7db8632c34a4c91242282590707c8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">timeout：-1 表示阻塞、0表示只遍历1次。正整数则表示超时时间。</span></span></li><li id="https://www.notion.so/039edf9e110e46b898896ae007c142ee" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">返回值：0表示超时、-1表示错误、正整数表示就绪的事件数。</span></span></li></ul><h2 id="https://www.notion.so/b42398569fb1466682faf9fc560bc301" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b42398569fb1466682faf9fc560bc301"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">select和poll的区别</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/1ec9cf5f1b5f4f93b989707461dffa8b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">是否有文件描述符数量的限制。</span></span></li><li id="https://www.notion.so/b0c857d31b894cf3ae8c5274479cd29b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">是否需要在每次调用之后重新构造fds。</span></span></li></ol><h2 id="https://www.notion.so/a6a1c7540c4b44158363df7d13f3c1cc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a6a1c7540c4b44158363df7d13f3c1cc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">select和poll存在的问题</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/7011ec4fa0084566872d58b433683160" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">每次调用都需要轮询所有文件描述符，效率较低。</span></span></li><li id="https://www.notion.so/fc25d0226e1140e69a9bd315ad5cc1e2" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">每次调用需要在用户态和内核态之间来回拷贝数据。</span></span></li></ol><h2 id="https://www.notion.so/2107152e43a24dd48edd2d84173e3136" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2107152e43a24dd48edd2d84173e3136"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Epoll</span></span></h2><div id="https://www.notion.so/d011002d74604240883faaa2f0a4344f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Epoll也即event poll</span></span></p></div><h3 id="https://www.notion.so/c882e0030487442cb4adf514dfee5a96" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c882e0030487442cb4adf514dfee5a96"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">创建epoll实例</span></span></h3><pre id="https://www.notion.so/721e8c1169d14458afec3f7ebfc0c1ae" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/b0a3d5bb5ed64cbc9baf22d5e9c8b354" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/b0a3d5bb5ed64cbc9baf22d5e9c8b354"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">修改兴趣列表</span></span></h3><pre id="https://www.notion.so/6cd120ec17de4571a3add7a0c27d60e5" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// epfd就是上面创建的epoll实例</span>
<span class="token comment">// op: 操作(添加、更新、删除)</span>
<span class="token comment">// fd: 要监听的文件描述符</span>
<span class="token comment">// ev: 是一个结构体，包含两个字段。events传递感兴趣的集合；data在fd成为就绪态之后用于指定传递给调用进程的信息。</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span> ev<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/0649de1c7c8b428b811f627e17abd08f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0649de1c7c8b428b811f627e17abd08f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">事件等待</span></span></h3><pre id="https://www.notion.so/f59f7df7b7f94cf88642b2070aab0084" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// evlist： 用于记录就绪的文件描述符信息</span>
<span class="token comment">// max_events：指定evlist包含的元素数量</span>
<span class="token comment">// 返回值：-1错误、0超时、正整数则表示就绪的文件描述符数量</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epid<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span> evlist<span class="token punctuation">,</span> <span class="token keyword">int</span> max_events<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/c4ebac8d2c7e4066a6069b5151f9d98f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c4ebac8d2c7e4066a6069b5151f9d98f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">过程</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/137eadcbd79547b7a6d7121325e3a3bd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">文件描述符被注册之后，每当执行IO操作使文件描述符就绪时，内核就会在epoll的就绪列表中添加一个元素。</span></span></li><li id="https://www.notion.so/37418442f6cf4937ba57fc77be80d47a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每次调用epoll_wait，就是从就绪列表中取元素。</span></span></li><li id="https://www.notion.so/2df07b1bacfe4aa4806f26cfde8e974c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">epoll在内核中建立数据结构，每次只返回就绪的文件描述符，避免了重复复制大量的文件描述符。</span></span></li><li id="https://www.notion.so/b1efa209102b423585a316964626db10" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">epoll默认为水平触发，可以在调用epoll_ctl时将其设置为边缘触发。</span></span></li></ul><h2 id="https://www.notion.so/3dd773cf252941fa8ff78c6c14736ead" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3dd773cf252941fa8ff78c6c14736ead"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">参考资料</span></span></h2><div id="https://www.notion.so/3240e03cc9bf425f994ed6476c6edddb" class="PDF"><div class="PDF__Content"><embed width="192" height="96" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5521a144-bcf4-4f76-8554-88b77f5c7ff1%2FLinux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C%EF%BC%88%E4%B8%8B%E5%86%8C%EF%BC%89.pdf?table=block&amp;id=3240e03c-c9bf-425f-994e-d6476c6edddb" type="application/pdf"/></div></div><div id="https://www.notion.so/4ad60206ec1e4ab888ba2944e426210f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&amp;mid=2247494866&amp;idx=1&amp;sn=0ebeb60dbc1fd7f9473943df7ce5fd95&amp;chksm=c2c5967ff5b21f69030636334f6a5a7dc52c0f4de9b668f7bac15b2c1a2660ae533dd9878c7c&amp;scene=178&amp;cur_album_id=1703494881072955395#rd">https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&amp;mid=2247494866&amp;idx=1&amp;sn=0ebeb60dbc1fd7f9473943df7ce5fd95&amp;chksm=c2c5967ff5b21f69030636334f6a5a7dc52c0f4de9b668f7bac15b2c1a2660ae533dd9878c7c&amp;scene=178&amp;cur_album_id=1703494881072955395#rd</a></span></span></p></div><div id="https://www.notion.so/1884d55155f64539928137b80780379d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; Notablog 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>