---
title: redis的AOF持久化存储
date: 2020-10-06 20:53:49
tags:
- Redis
- 数据库
---
AOF全称为Append Only File,即仅仅向文件中追加命令

## AOF实现

<!--more-->

- AOF保存了每一条写指令(包括删除指令)
- AOF的实现包含三步,分别是追加,写入和同步.
   - 追加. 将最新的写命令追加到缓冲区中.
   - 写入和同步.将缓冲区中的内容写入到文件中,以及将内存中的文件同步到磁盘中.(如果不同步到磁盘中,发生故障时内容一样会丢失)
- 可以通过修改redis.conf文件中的appendfsync的值来修改AOF的写入和同步方式:
  - no.只是将缓存区中数据写入文件缓冲区中,何时同步文件缓冲区和磁盘中的文件由操作系统决定.(速度最快,但是安全性较差,发生故障会丢失较多数据)
  - always.将缓冲区中数据写入文件缓冲区中,每一轮事件循环都同步文件缓冲区和磁盘中的文件.(安全性最高,但是性能较差,需要进行大量磁盘读写操作)(该种方法也可能会丢失数据,最多丢失一个事件循环的写命令).
  - everysec.将缓冲区中数据写入文件缓冲区中,在每一轮事件循环中判断,如果距离上次同步超过一秒,就再次同步文件缓冲区和磁盘中的文件.(折中办法)
    
- 事件循环:Redis的服务进程就是一个事件循环,该事件循环包括三部分:
  - 用户命令的处理.读取用户命令并打印相应输出,还可能会将命令写入aof缓冲区
  - 处理时间事件.
  - 判断是否需要写入和同步aof文件.

## AOF的载入和还原

- 启动redis时,若开启了AOF功能则载入aof文件,否则载入rdb文件.
- 载入aof文件时,redis将逐个执行aof文件中的命令(离线)

## AOF的重写
不断追加AOF文件将导致AOF文件体积膨胀,为了解决这个问题,需要进行AOF文件重写.
- AOF文件重写会开启一个新的进程,并复制当前数据库的状态
- 之后逐个读取每个数据库中的数据,根据数据库中的数据创建写指令存入新AOF文件(不涉及旧AOF文件的读写).
- AOF重写的过程中主进程继续接受用户的指令,如果用户输入了写指令,则该指令除了被执行以外,还会追加到AOF缓冲区和AOF重写缓冲区.
- 如果AOF重写完毕之后,将会向主进程发送信号,之后主进程阻塞用户命令的处理,将AOF重写缓冲区中的指令追加到新AOF文件中,追加完毕之后,新AOF文件将会原子地替换掉旧AOF文件.