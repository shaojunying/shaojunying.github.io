---
title: Redis中的跳跃表
date: 2020-10-28 16:54:53
tags:
- Redis
- 数据库
---

## Redis中跳跃表的实现

Redis中跳跃表的实现类时zskiplist,每个节点的实现是zskiplistnode.

### z_skip_list_node的实现

```c
struct zskiplistnode{
    // 层
    struct{
        // 前进指针
        zskiplistnode * forward;
        // 跨度
        int span;
    }

    // 后退指针
    zskiplistnode * back;

    // 分值
    double score;

    // 实例对象
    robj * obj;
}
```

跳跃表的节点如上所示

#### 层

跳跃表节点的level数组可以包含多个元素,每个元素都包含一个只想其他节点的指针,从而加快查找速度.

一般来说,层数越大,查询速度越快.

层数大小是通过幂次定律(值越大出现的概率越小)来从1-32随机取值的.

##### 前进指针

level数组中每个元素都包含一个前进指针和跨度,前进指针指向后面的节点,而跨度则记录两个节点之间的距离

前进指针用来从前向后访问节点的.可以通过一直使用跨度为1的前进指针来遍历整个跳跃表.

##### 跨度

指向null的前进指针的跨度为0

遍历到指定节点路程上的跨度之和即为该节点的排位

#### 后退指针

后退指针用来从后向前访问节点的,可以用来从后向前遍历整个跳跃表.

后退指针只能逐个访问节点,不像前进指针可以一次跳过多个节点.

#### 分值和成员对象

所有节点按照分值从小到达排序,如果分值相同,则按照成员对象的字典序排序

每个节点的成员对象必须唯一,而分值可以相同

### z_skip_list实现

```c
struct zskiplist{
    // 头尾节点
    struct zskiplistnode * head, tail;

    // 节点总数量
    int length;

    // 所有层的层数最大值(不包括空的表头结点)
    int level;
}
```

如上所示是跳跃表的结构,其中head指向空的头节点,tail则指向尾节点.

跳跃表中包含一个空的头,每次查询都是从空的头节点开始的.