---
title: Redis中的字典
date: 2020-10-27 14:32:28
tags:
- Redis
- 数据库
---

## 字典的实现

字典的底层是基于哈希表实现的,哈希表中的每一个节点保存了字典的一个键值对

### 哈希表的实现

```c
struct dictht{
    // 数组,存储哈希表中的节点
    dictEntry ** table;
    // 数组的大小
    unsigned long size;
    // 掩码 用于计算索引值
    unsigned long sizemask;
    // 该哈希表已有的节点
    unsigned long used;
}
```

哈希表的结构如上所示,其中数组table中的每一项对应哈希表中的一个节点.sizemask的值总是size的值减1,这个属性和哈希值一起决定了新节点应该放在table的哪个地方.

### 哈希表节点的实现

```c
struct dictEntry{
    // 当前的键
    void * key;
    // 当前的值
    union(
        void * val;
        uint64_tu64;
        int64_ts64
    ) v;
    // 存储下一个节点的指针
    dictEntry * next;
}
```

如上是哈希表节点的实现,其中key是键值对的键,v是键值对的值,next指向另一个哈希表节点的指针,用于解决哈希冲突.

### 字典的实现

```c
struct dict{
    // 类型特定函数
    dictType * type;
    // 私有数据
    void * privdata;
    // 哈希表
    dictht ht[2];
    // rehash进度
    int trehashidx;
}
```

如上是字典的数据结构
- 类型特定函数`type`中存储一些指针类型对应的函数实现,例如`计算哈希值`, `复制节点`....
- `privdata`存储要传给类型特定函数的可选参数
- 哈希表`ht`存储两个哈希表,一般只使用ht[0],只有在对ht[0]进行rehash时才会使用ht[1]
- rehash进度`trehashidx`记录当前rehash的进度,没有进行rehash操作时该变量为-1.

## 哈希算法

找节点在哈希表中位置的过程如下

1. 使用类型特定函数计算节点的hash值`hash = dict->type->hashFunction`
2. 将hash值与掩码取余获得索引值`index = hash & dict->ht[0]->sizemask`

## 解决键冲突

多个哈希节点使用next指针构成一个链表,遇到冲突时,即向链表中添加节点即可.

*由于哈希表没有保存链表的尾节点,所以每次添加新结点都是添加在链表的头部.*

## rehash

### rehash的步骤

1. 为ht[1]分配空间
   - 如果是扩展,那么新容量为第一个大于等于`dict->ht[0].used*2`的2的n次方
   - 如果是收缩,那么新容量为第一个大于等于`dict->ht[0].used`的2的n次方
2. 为`dict->ht[0]`中元素重新计算hash值,将其移动到dict[1]上.
3. 移动完毕之后销毁ht[0]的空间,将ht[0]指向ht[1]所在空间,在ht[1]上创建一个空哈希表,为下一次hash做准备.

### rehash的时机

- 扩展
  - 如果此时正在进行bgsave或者bg_rewrite_aof,且装载因子大于等于5
  - 如果没有进行上述操作,装载因子大于等于1
- 收缩
  - 装载因子小于0.1

#### bg_xxx时装载因子大于等于5才保存的原因

大多数操作系统都采用`写时复制`的策略来提高子进程的效率,为了减少内存的读写,最大限度节约内存.

`写时复制`:在创建子进程之后,父子进程共用同一片内存区域,只有父子进程有一方要对内存中内容做修改时才复制内存区域的内容.

## 渐进式rehash

rehash动作不是一次性完成的,而是分多次、渐进式进行的.通过这种方式将计算量均摊到每次对字典进行增删改查的操作上，避免了集中进行rehas的工作量。

### 渐进式rehash的步骤

1. 为ht[1]分配空间，使字典同时持有两个哈希表。
2. 将trehashidx置为0，rehash工作正式开始
3. 每次对字典进行增删改查时，除了执行对应操作外，还会将trehashidx索引上的节点rehash到ht[1]上，并将trehashidx加1
4. 随着字典操作的不断进行，待rehash操作完成之后，会将trehashidx重新置为-1，表示rehash操作结束。

### 渐进式rehash注意事项

渐进式rehash过程中，

- 增加、删除、修改都会在ht[0]和ht[1]两个表上进行。例如：对字典进行查找操作时，会现在ht[0]上作查找，如果查找失败，再去ht[1]上做查找
- 新增加的键都会添加到ht[1]上，从而保证ht[0]只减不增