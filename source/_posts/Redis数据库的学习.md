---
title: Redis数据库的学习
date: 2020-10-25 20:36:36
tags:
- Redis
- 数据库
---

## 服务器中的数据库

Redis服务器的数据结构如下所示

```c
struct redisServer{
    // ...
    // 一个redisDb数组，其中的每一项对应redis的一个数据库
    redisDb * redisDb;
    // ...
    // redis数据库的数量 
    int redisDbNum;
    // ...
}
```

如上所示，redisServer中一个redisDb数组存储所有数据库对应的指针，redisDbNum存储数据库的数量

## 客户端切换数据库

Redis客户端的数据结构如下所示

```c
struct redisClient{
    // ...
    // 客户端当前数据库的指针
    redisDb * db;
    // ...
}
```

如上所示，redisClient中一个redisDb指针存储当前数据库的地址，切换数据库只需修改该指针的值即可。该指针的值都是redisServer中数据库数组的地址。

## redis数据库的结构

redisDb结构如下所示

```c
struct redisDb{
    //...
    // 存储该数据库中的所有键值对
    dict * dict;
    //...
    // 存储每个有过期时间的键对应的过期时间
    dict * expires;
    //...
}
```

如上所示，字典类型的dict存储数据库中的所有键值对，key即为键，value为键值对的值，之后对键值对的增删改查都是对dict变量进行操作。

字典类型的expires存储数据库中含有过期时间的键及其过期时间，key为键，value为过期时间对应的时间戳。其中两个字典中相同的键对应的key是同一个key，避免了内存浪费。对于过期时间的增删改查也是基于expires变量进行的。

redis中设置过期时间有四种方式，分别是设置生存时间或过期时间，单位是秒或毫秒，最终都被转化为同一种方式：以毫秒为单位的过期时间。

TTL指令可以返回指定key对应的剩余存活时间，具体实现就是过期的时间戳减去当前时间戳。

## redis过期键的删除方式

### 三种可能的删除策略

#### 定时删除

为键设置过期时间时启动一个定时器，在过期时间来临时，立即删除这个键

##### 特点

对内存最友好，但是占用太多CPU时间。

#### 惰性删除

在到达过期时间不会立即删除，而是在获取key对应的值的时候判断该key是否到期，如果到期则直接删除，之后返回空；否则返回对应的value值。

##### 特点

对CPU最友好，但是会造成内存浪费，甚至导致内存泄漏。

#### 定期删除

每隔一段时间检查一次数据库，删除其中过期的键。

##### 特点

前两种方案的折中方案，对于CPU和内存都较友好。但是较难把握每次检查之间的间隔时间，如果太长将退化为惰性删除；太短又会退化为定时删除。

### Redis采用的删除策略

Redis采用惰性删除和定期删除两种方案。

#### 惰性删除

Redis在对于**任何**键进行读写的时候，都会首先执行惰性删除，如果过期则删除并返回空，否则返回对应的值

#### 定期删除

Redis会定期轮询整个数据库，从数据库中随机选择指定个键，如果键过期就删除。并且在定期删除超时后退出，下次从下一个数据库进行定期删除。

伪代码如下所示

```c
// 默认每次检查的数据库数量

// 默认每次从每个数据库中随机取的键的个数

// 当前要执行定期删除的数据库序号

while(){
    // 获取当前数据库

    // 将数据库序号指向下一个数据库

    // 从数据库中随机选择指定个元素,
    // 如果超过过期时间,就删除该元素

    // 如果当前函数执行超时了,退出,下次从下一个数据库开始执行
    // 否则继续下一轮循环
}
```

### 主从同步的删除方式

主从同步中从服务器发现过期键不进行删除,而是等待主服务器删除过期键之后发来删除指令才进行删除。从而保证了主从服务器的数据的一致性。

### RDB和AOF中的过期键删除

#### RDB

RDB在保存的时候只会保存为过期的键，读取RDB文件时，主服务器会忽略过期键，但是从服务器仍会读取过期键。在之后主从服务器进行数据同步时从服务器的数据会被清空，所以过期键一般不会对RDB操作造成影响。

#### AOF

如果有键过期，系统会对AOF文件追加一条DEL指令

所以在客户端获取过期的键时会分为三步：

1. 删除键
2. 向AOF追加DEL命令
3. 返回空

在AOF文件重写的过程中，会忽略过期的键

