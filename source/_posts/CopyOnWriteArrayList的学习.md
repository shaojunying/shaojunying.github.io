---
title: CopyOnWriteArrayList的学习
date: 2020-11-03 15:18:10
tags:
- Java
- 集合类
- 并发
---

## 原理

`写时复制`:多个调用者同时请求相同资源,那么他们会使用相同的指针指向相同的资源,直到有个调用者要修改该资源时,系统才会为该调用者复制一份专属资源.

## 实现

- CopyOnWriteArrayList底层也是基于数组实现的,与ArrayList类似.
- 增删改(add,remove,clear,set)会首先加一个锁(不是方法锁,是对一个变量加锁),将原来的数组复制一份,后续的操作都作用在新数组上,之后将数组指针指向新数组.
- 迭代:迭代不用加锁,首先会保存当前数组的指针,之后的操作都是在该数组上进行,不受后续的更新操作的影响.

## 缺点

- 内存占用大:每次更新都要复制一个新数组,如果更新较频繁,则需要多次复制数组.
- 只能保证最终一致性,不能保证实时一致性:如果在一个线程迭代过程中另一个线程修改数组,该更新不会体现在迭代上(迭代一直在原数组上进行).

## CopyOnWriteArraySet

CopyOnWriteArraySet也是基于CopyOnWriteArrayList的,只是在add时首先判断list中是否存在该元素.
